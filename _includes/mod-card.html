{% comment %}
  Recursive include for rendering mod cards with their children
  Parameters:
    - mod: the mod object from the YAML data
    - depth: The depth of the current mod (integer)
    - lineage_color: Always 'base-game' (Green)
    - family_color: The color of the closest Engine/Platform ancestor ('base-game', 'engine-family', or 'platform-family')
{% endcomment %}

{% assign mod = include.mod %}
{% assign story_class = "" %}
{% if mod.is_story %}
  {% assign story_class = "story-mod-container" %}
{% endif %}

{% assign current_depth = include.depth | plus: 0 %}

{% comment %} 
  1. Determine the family color to pass down.
     - If this mod is a Family type, it becomes the new lineage anchor.
     - Otherwise, it passes its parent's family color down.
{% endcomment %}
{% assign next_family_color = include.family_color %}
{% if mod.type == "engine-family" or mod.type == "platform-family" %}
  {% assign next_family_color = mod.type %}
{% endif %}
{% assign next_depth = current_depth | plus: 1 %}

<div class="flow-branch {{ story_class }}">
  <div class="mod-card {{ mod.type }} {% if mod.type != 'base-game' and mod.type != 'engine-family' and mod.type != 'platform-family' %}regular-mod{% endif %}" 
       onclick="toggleCard(this); event.stopPropagation();" 
       data-id="{{ mod.id }}"
       data-depth="{{ current_depth }}"
       data-lineage-color="{{ include.lineage_color }}"
       data-family-color="{{ include.family_color }}">
    <div class="mod-header">
      <div class="mod-title">{{ mod.name }}</div>
      <div class="mod-badges">
        {% if mod.hierarchical_children %}
          <svg class="expand-icon" fill="currentColor" viewBox="0 0 20 20">
            <path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd"/>
          </svg>
        {% endif %}
        {% if mod.badge %}
          {% if mod.badge == "vanillaplus" %}
            <span class="mod-badge badge-{{ mod.badge }}">Vanilla+</span>
          {% else %}
            <span class="mod-badge badge-{{ mod.badge }}">{{ mod.badge | capitalize }}</span>
          {% endif %}
        {% endif %}
      </div>
    </div>
    <div class="mod-details">
      <div class="mod-description">{{ mod.description }}</div>
      {% if mod.link %}
        <a href="{{ mod.link }}" class="mod-link">View Details â†’</a>
      {% endif %}
    </div>
  </div>
  
  {% if mod.hierarchical_children %}
    <div class="hierarchical-children hidden" data-parent="{{ mod.id }}">
      {% for child in mod.hierarchical_children %}
        {% assign child_story_class = "" %}
        {% if child.is_story %}
          {% assign child_story_class = "story-mod-container" %}
        {% endif %}
        
        <div class="hierarchical-item {{ child_story_class }}">
          {% include mod-card.html 
            mod=child 
            depth=next_depth
            lineage_color=include.lineage_color
            family_color=next_family_color %}
        </div>
      {% endfor %}
    </div>
  {% endif %}
</div>
