{% comment %}
  Recursive include for rendering mod cards with their children
  Parameters:
    - mod: the mod object from the YAML data
    - parent_types: A space-separated string of all ancestor types (e.g., 'base-game engine-family')
    - current_parent_color_class: The family color class of the immediate parent (e.g., 'base-game', 'engine-family', or 'platform-family')
{% endcomment %}

{% assign mod = include.mod %}
{% assign story_class = "" %}
{% if mod.is_story %}
  {% assign story_class = "story-mod-container" %}
{% endif %}

{% comment %} 
  1. Build the full ancestor type string.
{% endcomment %}
{% assign ancestor_types = mod.type %}
{% if include.parent_types and include.parent_types != blank %}
  {% assign ancestor_types = include.parent_types | append: " " | append: mod.type %}
{% endif %}

{% comment %} 
  2. Determine the color class to pass down to children for their Bar 1 (Lineage).
     - If this mod is a Family type, it becomes the new lineage anchor.
     - Otherwise, it passes its parent's lineage color down.
{% endcomment %}
{% assign next_parent_color_class = include.current_parent_color_class %}
{% if mod.type == "engine-family" or mod.type == "platform-family" %}
  {% assign next_parent_color_class = mod.type %}
{% elsif next_parent_color_class == blank %}
  {% comment %} Fallback for first level if parent_types isn't set (shouldn't happen with correct stalker-map.html) {% endcomment %}
  {% assign next_parent_color_class = "base-game" %}
{% endif %}

<div class="flow-branch {{ story_class }}">
  <div class="mod-card {{ mod.type }} {% if mod.type == 'regular' %}regular-mod{% endif %}" 
       onclick="toggleCard(this); event.stopPropagation();" 
       data-id="{{ mod.id }}"
       data-ancestors="{{ ancestor_types | strip }}"
       data-parent-color="{{ include.current_parent_color_class }}">
    <div class="mod-header">
      <div class="mod-title">{{ mod.name }}</div>
      <div class="mod-badges">
        {% if mod.hierarchical_children %}
          <svg class="expand-icon" fill="currentColor" viewBox="0 0 20 20">
            <path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd"/>
          </svg>
        {% endif %}
        {% if mod.badge %}
          {% if mod.badge == "vanillaplus" %}
            <span class="mod-badge badge-{{ mod.badge }}">Vanilla+</span>
          {% else %}
            <span class="mod-badge badge-{{ mod.badge }}">{{ mod.badge | capitalize }}</span>
          {% endif %}
        {% endif %}
      </div>
    </div>
    <div class="mod-details">
      <div class="mod-description">{{ mod.description }}</div>
      {% if mod.link %}
        <a href="{{ mod.link }}" class="mod-link">View Details â†’</a>
      {% endif %}
    </div>
  </div>
  
  {% if mod.hierarchical_children %}
    <div class="hierarchical-children hidden" data-parent="{{ mod.id }}">
      {% for child in mod.hierarchical_children %}
        {% assign child_story_class = "" %}
        {% if child.is_story %}
          {% assign child_story_class = "story-mod-container" %}
        {% endif %}
        
        <div class="hierarchical-item {{ child_story_class }}">
          {% include mod-card.html 
            mod=child 
            parent_types=ancestor_types 
            current_parent_color_class=next_parent_color_class %}
        </div>
      {% endfor %}
    </div>
  {% endif %}
</div>
